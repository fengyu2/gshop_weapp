"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Api=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_constant=require("../config/constant.js"),_index=require("../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_dialog=require("./dialog.js"),_storage=require("./storage.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var Api={DEBUG:!1,BASE:_constant.ApiConstant.BASE,setDebug:function(e){Api.DEBUG=e},debug:function(e,i){Api.DEBUG&&(i?console.log(e,i):console.log(e))},errorInterceptors:[],addErrorInterceptor:function(e){Api.errorInterceptors.push(e)},apiTokenValue:null,apiToken:function(e){if(void 0!==e)return Api.debug(">> Api.apiToken -> "+e),_index2.default.setStorageSync("apiToken",e),Api.apiTokenValue=e;if(null===Api.apiTokenValue){var i=_index2.default.getStorageSync("apiToken");Api.apiTokenValue=i||""}return Api.apiTokenValue},defaultCallback:function(i,o){if(o=o||{},"object"===(void 0===i?"undefined":_typeof(i))&&"code"in i){var e=i.code,t="",n="";"msg"in i&&(t=i.msg),"redirect"in i&&(n=i.redirect),"data"in i&&i.data;var a=function(e){e&&Api.debug(">> >> Api.defaultCallback -> redirect("+e+")")};0===e?"success"in o?o.success(i):n?t?_index2.default.showModal({title:"提示",content:t,showCancel:!1,success:function(e){a(n)}}):a(n):_index2.default.showToast({title:t,success:function(e){a(n)}}):function(){for(var e=0;e<Api.errorInterceptors.length;e++)if(!Api.errorInterceptors[e](i))return;"error"in o?o.error(i):n?t?_index2.default.showModal({title:"提示",content:t,showCancel:!1,success:function(e){}}):a(n):_index2.default.showModal({title:"提示",content:t,showCancel:!1,success:function(e){a(n)}})}()}else _dialog.Dialog.tipError("数据:"+JSON.stringify(i))},request:function(e,i,o){i=i||{},Api.debug(">> Api.request -> api("+Api.BASE+e+")"),Api.debug(">> ",i),_index2.default.request({url:Api.BASE+e,data:i,method:"POST",dataType:"json",header:{"Content-Type":"application/x-www-form-urlencoded","api-token":Api.apiToken(),"api-env":_constant.ApiConstant.ENV,"api-param":JSON.stringify(_storage.Storage.getObject("apiParam",{}))},success:function(e){Api.debug(">> >> Api.request -> success"),Api.debug(">> >> ",e),e.header["api-token"]&&Api.apiToken(e.header["api-token"]);try{var i=e.data;if("string"==typeof i&&(i=JSON.parse(e.data)),!("code"in i))throw"response error";o(i)}catch(e){o({code:-1,msg:"请求错误:"+e})}},fail:function(e){Api.debug(">> >> Api.request -> fail"),Api.debug(">> >> ",e),o({code:-1,msg:"请求错误"})}})},process:function(e,i,o,t,n){n&&n.loading&&_dialog.Dialog.loadingOn(),Api.request(e,i,function(e){n&&n.loading&&_dialog.Dialog.loadingOff(),Api.defaultCallback(e,{success:function(e){o&&o(e)},error:function(e){t?t(e):Api.defaultCallback(e)}})})},processSuccess:function(e,i,o,t){t&&t.loading&&_dialog.Dialog.loadingOn(),Api.request(e,i,function(e){t&&t.loading&&_dialog.Dialog.loadingOff(),Api.defaultCallback(e,{success:function(e){o&&o(e)}})})},upload:function(i,e,o,t){Api.debug(">> Api.upload -> api("+Api.BASE+i+") -> file("+e+")"),_dialog.Dialog.loadingOn("正在上传..."),o=o||Api.defaultCallback,t=t||Api.defaultCallback,_index2.default.uploadFile({url:Api.BASE+i,filePath:e,name:"file",header:{"api-token":Api.apiToken()},success:function(e){Api.debug(">> >> Api.upload -> success"),Api.debug(">> >> ",e),_dialog.Dialog.loadingOff();try{var i=e.data;if("string"==typeof i&&(i=JSON.parse(e.data)),!("code"in i))throw"response error";Api.defaultCallback(i,{success:o,error:function(e){for(var i=0;i<Api.errorInterceptors.length;i++)if(!Api.errorInterceptors[i](e))return;t(e)}})}catch(e){console.error(e),Api.defaultCallback({code:-1,msg:"请求错误"},{error:t})}},fail:function(e){Api.debug(">> >> Api.upload -> fail"),Api.debug(">> >> ",e),_dialog.Dialog.loadingOff(),t?t({code:-1,msg:"上传失败"}):_dialog.Dialog.tipError("上传"+i+"请求失败")}})}};exports.Api=Api;