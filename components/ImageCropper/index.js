"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageCropper=void 0;var _class,_temp2,_createClass=function(){function o(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,e,i){return e&&o(t.prototype,e),i&&o(t,i),t}}(),_get=function t(e,i,o){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,i);if(void 0===r){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,i,o)}if("value"in r)return r.value;var s=r.get;return void 0!==s?s.call(o):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_image=require("../../lib/image.js"),_constant=require("../../config/constant.js"),_dialog=require("../../lib/dialog.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var ImageCropper=(_temp2=_class=function(t){function s(){var t,e,i;_classCallCheck(this,s);for(var o=arguments.length,r=Array(o),a=0;a<o;a++)r[a]=arguments[a];return(e=i=_possibleConstructorReturn(this,(t=s.__proto__||Object.getPrototypeOf(s)).call.apply(t,[this].concat(r)))).$usedState=["anonymousState__temp","anonymousState__temp2","anonymousState__temp3","anonymousState__temp4","ApiConstant","previewImage","previewWidth","previewHeight","ratio","cutterImageRawWidth","cutterImageRawHeight","cutterShow","cutterBoxWidth","cutterBoxHeight","cutterImage","cutterImageWidth","cutterImageHeight","cutterImageLeft","cutterImageTop","cutterWidth","cutterHeight","cutterTop","cutterLeft","image","__fn_onCrop"],i.state={previewImage:null,previewWidth:600,previewHeight:600,ratio:1,cutterImageRawWidth:0,cutterImageRawHeight:0,cutterShow:!1,cutterBoxWidth:750,cutterBoxHeight:0,cutterImage:null,cutterImageWidth:0,cutterImageHeight:0,cutterImageLeft:0,cutterImageTop:0,cutterWidth:500,cutterHeight:500,cutterTop:150,cutterLeft:150},i.touch={down:!1,x:0,y:0,cutterTop:0,cutterLeft:0},i.resizeTouch={down:!1,x:0,y:0,cutterHeight:0,cutterWidth:0},i.$$refs=[{type:"dom",id:"hHWwt",refName:"cropper",fn:null}],_possibleConstructorReturn(i,e)}return _inherits(s,_index2.default.Component),_createClass(s,[{key:"_constructor",value:function(t){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_constructor",this).call(this,t)}},{key:"componentWillMount",value:function(){this.setState({previewImage:this.props.image})}},{key:"componentDidMount",value:function(){var e=this;this.refs.cropper.boundingClientRect(function(t){e.setState({ratio:750/t.width,cutterBoxHeight:750*t.height/t.width-130})}).exec()}},{key:"doShowImage",value:function(t){var n=this;this.setState({cutterShow:!0,cutterImage:t}),_image.ImageUtil.getInfo(t,function(t){var e=void 0,i=void 0,o=t.width/t.height,r=n.state.cutterBoxWidth/n.state.cutterBoxHeight,a=t.width,s=t.height;r<o?i=(e=750)/o:(i=n.state.cutterBoxHeight,e=n.state.cutterBoxHeight*o),n.setState({cutterImageWidth:e,cutterImageHeight:i,cutterImageRawWidth:a,cutterImageRawHeight:s,cutterImageLeft:(750-e)/2,cutterImageTop:(n.state.cutterBoxHeight-i)/2})})}},{key:"doChooseImage",value:function(){var e=this;_index2.default.chooseImage({count:1,success:function(t){e.doShowImage(t.tempFiles[0].path)},fail:function(t){}})}},{key:"doConfirmImage",value:function(){var e=this;if(this.state.cutterShow){_image.ImageUtil.cutImage(this.state.cutterImage,this.state.cutterBoxWidth,this.state.cutterBoxHeight,this.state.cutterImageLeft,this.state.cutterImageTop,this.state.cutterImageWidth,this.state.cutterImageHeight,this.state.cutterLeft,this.state.cutterTop,this.state.cutterWidth,this.state.cutterHeight,function(t){e.__triggerPropsFn("onCrop",[null].concat([t]))},{canvasId:"myCanvas",context:this.$scope})}else _dialog.Dialog.tipError("请先选择图片")}},{key:"onCropperTouchStart",value:function(t){this.resizeTouch.down||this.touch.down||(this.touch.down=!0,this.touch.x=t.touches[0].clientX,this.touch.y=t.touches[0].clientY,this.touch.cutterTop=this.state.cutterTop,this.touch.cutterLeft=this.state.cutterLeft)}},{key:"onCropperTouchEnd",value:function(t){this.touch.down&&(this.touch.down=!1)}},{key:"onCropperTouchMove",value:function(t){if(this.touch.down){var e=this.touch.cutterLeft+(t.touches[0].clientX-this.touch.x)*this.state.ratio,i=this.touch.cutterTop+(t.touches[0].clientY-this.touch.y)*this.state.ratio;e=Math.max(e,0),i=Math.max(i,0),e=Math.min(e,this.state.cutterBoxWidth-this.state.cutterWidth),i=Math.min(i,this.state.cutterBoxHeight-this.state.cutterHeight),this.setState({cutterLeft:e,cutterTop:i})}}},{key:"onCropperResizeTouchStart",value:function(t){if(!this.resizeTouch.down)return this.resizeTouch.down=!0,this.resizeTouch.x=t.touches[0].clientX,this.resizeTouch.y=t.touches[0].clientY,this.resizeTouch.cutterHeight=this.state.cutterHeight,this.resizeTouch.cutterWidth=this.state.cutterWidth,!1}},{key:"onCropperResizeTouchEnd",value:function(t){this.resizeTouch.down&&(this.resizeTouch.down=!1)}},{key:"onCropperResizeTouchMove",value:function(t){if(this.resizeTouch.down){var e=this.resizeTouch.cutterWidth+(t.touches[0].clientX-this.resizeTouch.x)*this.state.ratio,i=this.resizeTouch.cutterHeight+(t.touches[0].clientY-this.resizeTouch.y)*this.state.ratio;e=Math.max(e,100),i=Math.max(i,100),e=Math.min(e,this.state.cutterBoxWidth-this.state.cutterLeft),i=Math.min(i,this.state.cutterBoxHeight-this.state.cutterTop);var o=Math.min(e,i);this.setState({cutterWidth:o,cutterHeight:o})}}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var t=_constant.ApiConstant.ENV===_constant.ApiConstant.ENV_WEAPP?(0,_index.internal_inline_style)({position:"absolute",left:"750px",top:"0",width:this.__state.cutterBoxWidth+"px",height:this.__state.cutterBoxHeight+"px"}):null,e=this.__state.cutterShow?null:(0,_index.internal_inline_style)({width:_index2.default.pxTransform(this.__state.previewWidth),height:_index2.default.pxTransform(this.__state.previewHeight)}),i=this.__state.cutterShow?(0,_index.internal_inline_style)({width:_index2.default.pxTransform(this.__state.cutterImageWidth),height:_index2.default.pxTransform(this.__state.cutterImageHeight),left:_index2.default.pxTransform(this.__state.cutterImageLeft),top:_index2.default.pxTransform(this.__state.cutterImageTop)}):null,o=this.__state.cutterShow?(0,_index.internal_inline_style)({width:_index2.default.pxTransform(this.__state.cutterWidth),height:_index2.default.pxTransform(this.__state.cutterHeight),left:_index2.default.pxTransform(this.__state.cutterLeft),top:_index2.default.pxTransform(this.__state.cutterTop)}):null;return Object.assign(this.__state,{anonymousState__temp:t,anonymousState__temp2:e,anonymousState__temp3:i,anonymousState__temp4:o,ApiConstant:_constant.ApiConstant}),this.__state}}]),s}(),_class.properties={image:{type:null,value:null},__fn_onCrop:{type:null,value:null}},_class.$$events=["onCropperTouchStart","onCropperTouchMove","onCropperTouchEnd","onCropperResizeTouchStart","onCropperResizeTouchMove","onCropperResizeTouchEnd","doConfirmImage","doChooseImage"],_class.options={addGlobalClass:!0},_class.defaultProps={image:null,onCrop:null},_temp2);exports.ImageCropper=ImageCropper,exports.default=ImageCropper,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(ImageCropper));